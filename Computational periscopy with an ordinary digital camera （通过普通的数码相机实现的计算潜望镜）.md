# Computational periscopy with an ordinary digital camera （通过普通的数码相机实现的计算潜望镜）

## 绪论

&emsp;&emsp;介绍非直视成像（non-line-of-sight imaging）概念以及领域现状：计算潜望镜至今都还是使用昂贵的光学器件实现。并介绍本文阐述的技术内容：二维计算潜望镜技术只需要数码相机拍照即可，该技术无需通过受控的或者随时间而变化的光源，当物体和场景都在相机的视线之外时，恢复不透明物体和物体后面（但未完全被遮挡）的场景的位置。以及技术的原理：这种恢复技术是基于不透明物体的可见半影可以和通过射线光学建模的隐藏场景具有的线性相关关系。最后阐述技术目前的使用领域：利用廉价设备来监测危险环境，导航和探测隐藏的敌人。  

## 简述瞬态成像过程

&emsp;&emsp;在典型的瞬态成像配置中，由光源和光检测器组成的成像设备无法直接观察场景，但可以直接观察漫反射表面，而漫反射表面本身可以直接观察场景。使用短光脉冲对漫射表面上的小斑点进行照明会产生 NLOS 场景的瞬态照明，这是通过从漫射表面反射后到达检测器的光间接观察到的。  
&emsp;&emsp;基于瞬态成像的 NLOS 场景几何恢复首先通过多点定位进行演示，并将该模型扩展为包括场景元素的可变反射率和非脉冲照明。随后的研究使用瞬态成像来推断观察者直接观察不到的非镜面物体的形状。该实验常使用飞秒激光与皮秒分辨率条纹摄像机。  

## 介绍该技术的具体内容

### 介绍这种技术相比之前技术的优势

&emsp;&emsp;NLOS分辨率基于感兴趣场景对已知大小和形状的遮挡物体半影影响的计算反演，该遮挡物体处于先验未知位置。  
&emsp;&emsp;之前的恢复方法需要被遮挡物的精确位置并需要以上设备。或生成场景移动部分的一维投影。该技术不需要校准、受控照明、时间分辨光检测或场景运动，并获得全彩色二维 (2D) 图像。  

### 介绍实验装置

![计算投影的实验装置](https://i.ibb.co/FYvdYBZ/image.png)图1 | 计算投影的实验设置。通过笔记本电脑控制，标准数码相机获取了可见成像墙上的辐照度分布快照，该分布是由于从感兴趣场景发出的光经过遮挡物的半影所引起的。为了方便使用多个场景进行实验，感兴趣的场景显示在液晶显示器上。该快照通过计算机算法进行处理，以恢复出感兴趣场景的图像，并估计隐藏遮挡物的位置。  

&emsp;&emsp;我们使用由 4 兆像素数码相机、宽高比为 4:3 的 20 英寸（1 英寸 = 2.54 厘米）液晶显示器 (LCD) 彩色监视器和黑色矩形遮挡物体组成的实验装置来演示计算潜望镜尺寸为 7.7 cm × 7.5 cm，由 7 毫米宽的黑色扁平支架支撑  
&emsp;&emsp;图像由LCD显示屏显示，图像发出的光通过黑色遮挡物照射在墙面，相机通过对墙面拍照获得测量图像  
&emsp;&emsp;LCD显示器发出的光，来自未知的显示场景和显示器的背景光，照亮了一个以正对显示器方向，距离为1.03米的可见白色Lambertian表面。使用显示器方便地测试多个场景；在补充资料中还呈现了使用2D和3D散射反射场景的其他结果。

    兰伯特表面指的是一种均匀散射的表面，具有如下特点：入射光在表面上被均匀地散射，并且不会在表面上出现反射。这种表面通常被称为完全漫反射表面，因为它能够在所有方向上以相同的强度散射光线。兰伯特表面在光学、电子学和计算机图形学等领域广泛应用，例如用于制作兰伯特球，用于摄像机的照明、计算机图形学中的光线追踪等。
&emsp;&emsp;光照分成了三种来源：LCD显示器显示图像的光，外界的背景光源，以及LCD显示器图像背景的光  
![图像重建过程](https://i.ibb.co/Kh0CVJQ/image.png)该图展示了图像重建的流程。a 部分，相机测量值进行去交错处理，得到来自 Bayer 模式测量的 RGB 数据，并对绿色通道进行平均。b 部分，估计遮挡物的位置。c 部分，通过相机测量和估计的遮挡物位置来重建隐藏场景。  
&emsp;&emsp;在这个实验中，相机测量的是一个原始的14位、2,016×2,016像素的图像，相机测量结果包括被遮挡物产生的阴影和半影。其中颜色通道按照Bayer滤波器RGBG模式交错。在对两个绿色通道进行平均和对每个颜色通道进行16×16块的平均之后，提取出三个126×126的图像（每个颜色通道一个），并将它们传递给计算机算法进行遮挡物位置和场景图tu像的恢复。

    Bayer滤色片是一种用于数码相机或手机摄像头的颜色滤镜阵列，其中每个像素只能检测红、绿或蓝三种颜色中的一种。它由一系列排列的透明色滤波器组成，按照红绿蓝的顺序排列。相邻的像素使用不同的滤波器来捕捉不同的颜色，使得相机或摄像头可以在每个像素处检测到完整的颜色信息。Bayer滤色片模式是最常见的数码相机传感器排列模式之一，其中绿色过滤器数量最多，因为人眼对绿色更敏感。  

### 计算墙面上Pw点的辐照度

**墙面上位置pw点的辐照度公式解释：f(x)为显示器场景辐照度，积分内容为pw所在场景的贡献，被积函数中第一个权重因子描述通量密度的径向衰减以及两种透视效应；第二个加权因子为可见性函数以及观察角度的因素；最后一项为区域外的源的贡献**  
&emsp;&emsp;在遮挡器位于显示器和可见墙之间的位置po，并且显示器距离为D的情况下，墙面上一个位置pw的辐照度由以下公式给出：
![辐照度计算公式](https://i.ibb.co/Gsbm6Xf/image.png)
&emsp;&emsp;该方程描述了在光源位置已知的情况下，遮挡体的位置和显示器上的场景图像如何影响可见墙面的照度分布。其中f(x)表示显示器场景辐射度，而积分则考虑了来自墙面位置pw整个场景中的贡献。

    在这个实验中，“wall patch”指的是被观察墙壁上的一个小区域，可以看作是一个像素点。这个区域的边界是由相邻像素点的中心线构成的，它们可以被离散化成一个网格。在这个实验中，照明场景（如电视屏幕）通过光线照射在墙壁上，产生了一个在这个区域上的辐照度分布，照相机可以捕捉到这个区域上的光强度信息。根据这个区域的光强度信息，可以反推出隐藏在障碍物后面的场景的图像和障碍物的位置。  
&emsp;&emsp;第一个权重系数是关于镜头视场中像素i对应的位置pw的距离衰减因子，它衡量了从场景点pw到像素i的距离，并乘以两个因素：第一个因素是与光通量密度有关的分母，表示光在空间中的强度随距离增加而下降。第二个因素是与垂直于入射光方向的物体表面的法线相对于镜头方向的夹角（投影因子）有关，它表示入射光与表面法线之间的夹角越小，表面接收到的光就越多。

    在这个公式中，pw-x 和 x-pw 是代表三维空间中两个位置之间的位移的向量。具体来说，pw-x 代表从 x 到 pw 的位移向量，而 x-pw 则代表从 pw 到 x 的位移向量。这些位移向量被用于计算辐射方程中第一个加权因子中的两个透视效应，以及第二个加权因子中的可见性项 V(x, pw; po) 的计算中。  
    在公式中，cos(α)和cos(β)代表了两个不同的余弦函数，它们各自表示两个不同的角度关系。

&emsp;&emsp;具体来说，cos(α)中的α是指场景中一个特定点（即x）和墙面某个位置（即pw）之间的夹角，它反映了相对于入射光线方向，点x相对于墙面位置pw的朝向角度。  

&emsp;&emsp;而cos(β)中的β则是指摄像机像素i的朝向与场景点x相对于墙面位置pw的视角之间的夹角，它反映了相对于像素i的视角，场景点x相对于墙面位置pw的方位角度。  

&emsp;&emsp;这两个cos函数在整个权重系数中起到了重要的作用，它们通过加权反映了场景中不同点和墙面不同位置的相对亮度和视觉角度。  

&emsp;&emsp;在这个公式中，第二个权重因子μ（x，pw）表示在墙壁位置pw观看场景位置x的监视器亮度因子。它考虑了从场景位置x到墙壁位置pw传播的光强度的衰减，该衰减受两点之间的距离和沿着光线路径的表面方向的影响。因子μ（x，pw）与场景无关，仅取决于望远镜系统的几何形状和x和pw的位置。假定它对从特定墙壁位置pw观看的所有场景位置都是恒定的。  

&emsp;&emsp;被积函数中的第一个权重因子模拟了通量密度的径向衰减（分母），以及两种透视效应：来自光线入射方向的墙面位置和来自像素视角的显示器像素，其中nx和nw分别为显示器和墙面的法线，∠(.,.) 表示其向量参数之间的夹角， ‖x‖2 表示向量的欧几里得范数。  

&emsp;&emsp;函数 V(x; pw; po) 表示场景位置 x 在墙位置 pw 处的可见性，假设遮挡物放置在位置 po。它是一个二元函数，如果在放置遮挡物的情况下 x 在 pw 处可见，则取值为 1，否则为 0。可见性取决于从 pw 到 x 和从 pw 到 po 的向量之间的角度，以及墙和场景的法线。实质上，V(x; pw; po) 确定了场景中的某个点 x 在墙上的给定位置 pw 处是否可见，考虑到位置 po 上的遮挡物。  

&emsp;&emsp;这个因子μ(x, pw)描述了显示器随着观察角度变化的辐射模型（在墙壁位置 pw 处查看的场景位置 x 的监视器亮度因子）  

&emsp;&emsp;最后一项 b(pw) 表示模型场景区域 S 外部的源在可见墙上的贡献。方程（1）是针对我们的设置改编的计算机图形学渲染方程。（3D 墙位置处的背景相关辐照度分量）  

### 恢复原理

&emsp;&emsp;假设可见墙面的反射是Lambertian（朗伯）的，那么可见墙面的降低分辨率数字照片可以通过将方程式（1）在相机视野内采用pw离散化的方式进行建模。

    在这个实验中，作者使用了方程(1)来模拟可见墙面的反射光，方程中包含了连续的积分和场景中的连续变量。为了在计算机上进行处理和模拟，作者使用了离散化的方法，将场景中的连续变量分为离散的小部分，例如，将场景分成一系列像素点，对每个像素点求出其对应的平均辐射值。这样，方程(1)就被转化为一个包含离散变量和离散积分的方程，可以在计算机上进行计算和模拟。

&emsp;&emsp;即，对于每个颜色通道，我们得到一个简单的仿射模型y = A(po)f + b，其中数字照片被矢量化为一个列向量，光传输矩阵A(po)有15,876行，列数取决于所尝试的重建分辨率。形成隐藏场景的图像相当于反转每个颜色通道的结果线性系统（对矩阵取逆）。

### 遮挡物的作用

**如果没有遮挡物，加权因子对x的依赖过弱，矩阵A的行相似度过高，在进行逆运算的时候难以恢复图像。有遮挡物可以使得函数V变化，矩阵A的列之间更加不同，改善其逆运算条件。**

&emsp;&emsp;能见度函数（等效地，遮挡物的存在）对于反演的条件至关重要。如果没有遮挡物，方程（1）中的加权因子对x的依赖关系太弱，不能很好地恢复f（x）的条件。  

![遮挡物的作用](https://i.ibb.co/12xxZ4y/image.png)我们的计算潜望镜场景中需要有遮挡物的存在，因为它极大地改善了光传输矩阵A（po）的反演条件，如图S4所示。遮挡物会在可见函数中产生变异性，从而增加A（po）列之间的变异性。如果没有遮挡物，由于成像平面上的每个点都能从隐藏场景中的每个点接收到光线，相机测量结果将非常平滑。因此，隐藏区域内的遮挡物改善了反问题的条件，并使得从单个相机测量中重建未知的隐藏场景成为可能。这种改进条件类似于编码孔径成像和参考结构层析成像所实现的。  
&emsp;&emsp;有遮挡物存在会引入阴影和半影，使得一些图像形成成为可能，但日常经验表明这种可能性极为有限。在离散化形式下，如果没有遮挡物，矩阵 A 的行之间相似度太高，无法进行良好的逆运算。  
&emsp;&emsp;由于遮挡物引起的可见性函数 V(x; pw; po) 的变化使得矩阵 A(po) 的列彼此更加不同，因此可以改善其逆运算的条件。  
&emsp;&emsp;通过将场景平面的一部分视为可解析的，当且仅当该部分在至少一个相机测量中可见并且在至少另一个相机测量中不可见时，我们定义了计算 FOV  
![计算视野定义](https://i.ibb.co/HHp70fN/image.png)文章中所提到的“场景平面”是指被隐藏的物体的表面，而“计算视场”（computational FOV）是指从相机视野的一部分看到的场景平面区域与从另一部分视野看不到的区域的交集。
在计算视场中，如果某个部分同时被多个遮挡物的边缘投影到相机视野中，那么这部分的逆问题矩阵的条件数会更好。其中最好的条件数区域是在相机视野内同时被四个遮挡物边缘投影到的场景平面区域（即region C）。  

### 使用极大似然估计找到使得po最大的A(po),通过y估计遮挡物po

&emsp;&emsp;从单快照相机测量y中恢复po和f是一个非线性问题。由于测量数（$A（p_o）$的行数）相对于可恢复分辨率的隐藏场景来说非常大，因此测量y靠近一个低维仿射子空间，该子空间依赖于遮挡物位置po和背景b。通过y估计遮挡物位置po，估计过程如下：
![极大似然法估计Po位置](https://i.ibb.co/vxFbvjj/image.png)  

    低维仿射子空间（low-dimensional affine subspace）是指在高维向量空间中，由少量基向量张成的仿射空间。由于维度较低，这个子空间中的向量可以由较少的线性组合表示。在本文中，指的是测量结果 y 的向量可以近似表示为占据少量基向量的仿射子空间，这个子空间与遮挡物位置 po 和背景 b 相关。

&emsp;&emsp;低维仿射子空间指的是由于被遮挡的场景的可恢复分辨率相对较小，因此由单个摄像机测量得到的数据y接近于一个低维仿射子空间。该子空间的维度由遮挡物的位置po和背景b决定。在公式中，A(po)是为特定遮挡位置po计算得到的光传输矩阵，忽略未知量b对估计结果的影响不会过大（详见补充材料）。在每个颜色通道上通过解决最大化问题获得的三个估计值被平均以获得单个p^o的估计值。  
&emsp;&emsp;式子的意思是寻找一个 occluder 位置po，使得计算得到的相机测量值 $A(p_o)$ $(A(p_o)^T A(p_o))^{-1}$ $A(p_o)^T(y-b)$与实际测量值 y 的二范数差最小。  
&emsp;&emsp;通过最小化这个二范数差，可以找到最能解释观测数据的 遮挡物 位置 $p_o$。因此，最终的 $\widehat{P_o}$ 是通过对三个通道的结果取平均得到的。  

### 关于隐藏场景$\widehat{f}$的估计

**通过遮挡物位置计算传输矩阵的估计值$\widehat{A}$，将向量话测量值通过$\widehat{A}$的伪逆矩阵表示为A†给出隐藏场景最小二乘估计。通过使用TV正则化提高重建的鲁棒性**

&emsp;&emsp;根据估计的遮挡物位置$p_o$，计算出真实光传输矩阵$A(p_o)$的估计值$\widehat{A}=A(\widehat{P_o})$。理想情况下，如果估计的遮挡物位置完全准确且模型不匹配和背景贡献可以忽略不计，那么将向量化测量值y（对于每个颜色通道）通过$\widehat{A}$的伪逆，表示为A†，将给出隐藏场景的RGB内容的最小二乘估计。  
![计算传输矩阵的估计值](https://i.ibb.co/ypfy5qt/image.png)

&emsp;&emsp;然而，为了提高重建对噪声和模型不匹配的鲁棒性，作者利用通常存在于现实世界场景中的横向空间相关性，通过使用总变差（TV）正则化来促进场景的梯度稀疏性。这个正则化项，表示为TV（f），被添加到优化目标中，以鼓励重建场景f具有平滑的梯度，并且由以下公式给出：TV(f) = ∑∥∇f∥1  
&emsp;&emsp;其中∇f是场景f的梯度，∥∥1项表示L1范数。通过加入这个正则化项，优化问题变为：最小化∥Af - y∥2 + λTV(f)  
其中λ是平衡数据保真度和正则化项的调节参数。解决这个优化问题可以得到隐藏场景f的最终估计。

    在这篇文章中，作者指的是现实世界场景中普遍存在的横向空间相关性。也就是说，当在场景中的一个区域发生变化时，通常与其相邻的区域也会发生相似的变化。例如，在一张照片中，天空的颜色可能会在整个画面中变化，而不仅仅是在照片中央。

&emsp;&emsp;这种横向相关性可以通过图像的梯度表示，其中每个像素的梯度表示其在横向上的变化。因此，通过促进场景的梯度稀疏性，可以利用这种横向相关性来提高图像恢复的鲁棒性。这可以通过应用总变分（TV）正则化来实现。  

    TV正则化是一种常用于图像恢复和处理中的正则化方法。它的基本思想是通过惩罚图像中的梯度来促进图像的平滑性，从而消除或减少图像中的噪声和伪影。TV正则化中的总变差是指梯度的L1范数，其可表示为图像的所有像素的梯度值的绝对值之和。因此，TV正则化在优化问题中被作为正则化项来惩罚梯度变化，以便在恢复过程中平滑图像并降低噪声。

&emsp;&emsp;在本文中，研究人员使用TV正则化来促进图像的平滑性并提高其鲁棒性，因为它利用了真实世界场景中普遍存在的横向空间相关性。通过应用TV正则化，他们可以在最小化测量误差和伪影的同时，进一步提高恢复图像的质量。  

    在方程式∥Af-y∥2中，∥·∥2表示欧几里得范数，它是两个向量之间距离的度量。在这个背景下，f表示隐藏场景的RGB内容，A表示估计的光传输矩阵，y表示来自相机的向量化测量值。术语Af是通过将隐藏场景的RGB内容f通过估计的光传输矩阵A投影而获得的估计测量值。术语∥Af-y∥2测量了估计测量值与来自相机的实际测量值之间的距离。目标是最小化这个距离，以获得隐藏场景的好估计RGB内容。  

### 通过对传输矩阵中的相邻矩阵进行差分计算，对图像质量进行进一步的提高

&emsp;&emsp;为了进一步提高图像质量，我们对相邻的16×16像素块及其对应的Â矩阵行进行差分，然后解决类似于方程（3）的优化问题。  
&emsp;&emsp;由于来自计算FOV之外的光具有较慢的空间变化，因此背景贡献b在相邻像素之间大致是恒定的（即bi+1 ≈ bi ≈ b），因此大致上被抵消。这意味着，在重建隐藏场景时，背景成分b的影响可以被减少。

    在这篇论文中，差分计算可以提高图像质量的原因是因为它可以消除邻域像素之间的背景影响。因为在邻域像素之间，背景光照的变化是缓慢的，因此可以将背景视为常量，从而通过差分计算来消除背景影响。这样，在求解最优化问题时，算法能够更加准确地估计隐藏场景的RGB值。同时，这种方法也能提高对环境光的鲁棒性，使得算法能够更好地处理复杂的场景。

![对矩阵进行差分计算](https://i.ibb.co/PDMYxjs/image.png)
&emsp;&emsp;其中，aiT 是 A 的第 i 行。这也为环境光提供了一定的鲁棒性，这得到了补充信息中描述的额外实验的验证。最终，由于所有显著的 y 变化都是由场景的这部分引起的，因此可以生成计算 FOV 的图像。  
&emsp;&emsp;这里的差分运算是指将相邻的像素值做差的操作。具体地，对于一张图像，可以将其分成若干个大小为 $16\times16$ 像素的块，然后对每个块的相邻行进行差分运算。这样可以得到一个与原始图像同样大小的差分图像，其中每个像素的值表示该像素与其上下相邻像素的差值。差分图像反映了图像的局部变化信息，有利于后续的优化求解。  
&emsp;&emsp;方程式aiTf表示光传输矩阵A的第i行对估计图像f的贡献。通过计算每行A的贡献并将它们相加，我们可以估计整个隐藏场景。所有y轴上的显著变化都是由计算FOV内部场景的部分引起的事实意味着估计图像f仅受到与该部分场景相互作用的光影响，而不受任何环境光或计算FOV外部的其他外部因素的干扰。这使我们能够产生一个相对自由于噪声和外部干扰的计算FOV图像。  

### 通过不同障碍物位置的观察结果进行非线性组合，从而得到一个降噪的图像

&emsp;&emsp;该方法利用了随着障碍物位置的变化而变化的光传输矩阵的一个性质。不准确的障碍物横向位置或深度会导致显示场景的估计被平移或放大（或缩小）。  
&emsp;&emsp;这种观察结果被用来产生额外的重建结果，这些结果被非线性地组合以产生一个降噪的图像。  

